<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ ÙˆØ§Ù„Ø£Ø³Ø¦Ù„Ø© â€” Firebase</title>
  <style>
    body{font-family:'Cairo',sans-serif;background:linear-gradient(135deg,#eef2f3,#8e9eab);margin:0;padding:0;color:#333}
    .wrap{max-width:1100px;margin:30px auto;background:white;border-radius:12px;box-shadow:0 8px 25px rgba(0,0,0,.15);padding:25px}
    h2{text-align:center;color:#0b63d6;margin-bottom:20px}
    button{background:#0b63d6;color:#fff;border:none;border-radius:8px;padding:8px 16px;cursor:pointer;transition:0.2s}
    button:hover{background:#084b9e}
    input,select,textarea{width:100%;padding:8px;margin-bottom:10px;border:1px solid #ccc;border-radius:8px}
    .list{margin-top:12px}
    .item{background:#f8f9fb;border:1px solid #ddd;border-radius:10px;padding:12px;margin-bottom:8px;box-shadow:0 2px 6px rgba(0,0,0,.04)}
    .hidden{display:none}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1;min-width:300px}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .meta{color:#666;font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <h2>ğŸ“‹ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ ÙˆØ§Ù„Ø£Ø³Ø¦Ù„Ø© â€” (Ù…ØªØµÙ„ Ø¨Ù€ Firebase)</h2>

    <!-- LOGIN -->
    <div id="login-view">
      <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
      <input id="login-username" placeholder="username (Ù…Ø«Ø§Ù„: mohamed)">
      <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
      <input id="login-password" type="password" placeholder="password">
      <div style="display:flex;gap:8px">
        <button id="btn-login">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
        <button id="btn-demo" style="background:#2ecc71">ØªØ¬Ø±ÙŠØ¨ (Guest Sales)</button>
      </div>
      <p class="meta">Ù…Ù„Ø­ÙˆØ¸Ø©: ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù‡Ù†Ø§ ÙŠØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ø¬Ù…ÙˆØ¹Ø© <strong>users</strong> ÙÙŠ Firebase (Ù„ÙŠØ³ Firebase Auth). Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ: <strong>Admin</strong> / <strong>Guess</strong></p>
    </div>

    <!-- MAIN -->
    <div id="main-view" class="hidden">
      <div class="header"><div>Ù…Ø±Ø­Ø¨Ù‹Ø§ <b id="user-name"></b> | Ø§Ù„Ø¯ÙˆØ±: <b id="user-role"></b></div>
        <div style="display:flex;gap:8px"><button id="btn-logout">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button><button id="btn-export" style="background:#16a085">ØªØµØ¯ÙŠØ± JSON</button></div>
      </div>

      <!-- ADMIN -->
      <div id="admin-panel" class="hidden">
        <h3>ğŸ‘‘ Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† (Nasr)</h3>
        <div class="row">
          <div class="col">
            <h4>Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù</h4>
            <input id="new-username" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
            <input id="new-password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <select id="new-role"><option value="sales">Sales</option><option value="admission">Admission</option></select>
            <button id="btn-add-user">Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù</button>
          </div>
          <div class="col">
            <h4>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h4>
            <div id="user-list" class="list"></div>
            <h4>ØªØ­ÙƒÙ… Ø§Ù„Ø¯Ø§ØªØ§</h4>
            <button id="btn-clear-data" style="background:#c0392b">Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (users/questions/slots/answers)</button>
          </div>
        </div>
      </div>

      <!-- SALES -->
      <div id="sales-panel" class="hidden">
        <h3>ğŸ’¼ Ù„ÙˆØ­Ø© Ø§Ù„Ø³ÙŠÙ„Ø²</h3>
        <div class="row">
          <div class="col">
            <h4>Ø£Ø¶Ù Ø³Ø¤Ø§Ù„Ù‹Ø§</h4>
            <textarea id="sales-question" rows="2" placeholder="Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„..."></textarea>
            <button id="btn-add-question">Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø³Ø¬Ù„ (ÙŠØ¸Ù‡Ø± Ù„Ù„Ø£Ø¯Ù…Ø´Ù†)</button>
          </div>
          <div class="col">
            <h4>Ø£Ø¶Ù Ù…ÙˆØ¹Ø¯Ù‹Ø§</h4>
            <label>ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</label>
            <input id="sales-slot" type="datetime-local">
            <label>Ø§Ù„Ù…Ø¯Ø© (Ø¯Ù‚Ø§Ø¦Ù‚)</label>
            <input id="sales-slot-duration" type="number" placeholder="Ù…Ø«Ø§Ù„: 30">
            <label>Ø§Ù„Ø³Ø¹Ø©</label>
            <input id="sales-slot-capacity" type="number" value="1">
            <button id="btn-add-slot">Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙˆØ¹Ø¯</button>
          </div>
        </div>

        <h4>ğŸ“… ÙƒÙ„ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ (Ù…Ø¹ Ù…Ù† Ø£Ù†Ø´Ø£Ù‡Ø§ ÙˆØ­Ø§Ù„Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯)</h4>
        <div id="sales-slots" class="list"></div>
        <h4>âœ… Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø¬Ø§Ø¨Ø©</h4>
        <div id="sales-answers" class="list"></div>
      </div>

      <!-- ADMISSION -->
      <div id="admission-panel" class="hidden">
        <h3>ğŸ§¾ Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ø´Ù†</h3>
        <div class="row">
          <div class="col">
            <h4>ğŸ•“ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</h4>
            <div id="pending-questions" class="list"></div>
          </div>
          <div class="col">
            <h4>ğŸ“† Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ (Ù…Ø¤ÙƒØ¯Ø©/ØºÙŠØ± Ù…Ø¤ÙƒØ¯)</h4>
            <div id="pending-slots" class="list"></div>
          </div>
        </div>

        <h4>âœ… Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø¬Ø§Ø¨Ø© (Ø³Ø¬Ù„)</h4>
        <div id="answered-questions" class="list"></div>
      </div>

    </div>

    <p class="meta" style="margin-top:12px">Ù…Ù„Ø§Ø­Ø¸Ø© Ø£Ù…Ø§Ù†: Ù‡Ø°Ø§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠØ³ØªØ®Ø¯Ù… Firestore Ø¨Ø´ÙƒÙ„ Ù…Ø¨Ø§Ø´Ø± Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­. Ù„Ù„Ø£Ù…Ø§Ù† ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬ Ø£Ù†ØµØ­ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Firebase Authentication + Ù‚ÙˆØ§Ø¹Ø¯ Ø£Ù…Ø§Ù† Firestore (Security Rules).</p>
  </div>

  <!-- Firebase + App logic -->
  <script type="module">
    // Firebase imports (v12.5.0)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    // ========== Paste your firebaseConfig here (you already provided it) ==========
    const firebaseConfig = {
      apiKey: "AIzaSyAwajjkF-6BwurrP_ZCcKXeLlwd4OU3BDs",
      authDomain: "stats-da730.firebaseapp.com",
      projectId: "stats-da730",
      storageBucket: "stats-da730.firebasestorage.app",
      messagingSenderId: "518680197445",
      appId: "1:518680197445:web:53c22b6fc25110c003e62c",
      measurementId: "G-P2TNW7S9JK"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Collections references
    const usersCol = collection(db, 'users');
    const questionsCol = collection(db, 'questions');
    const slotsCol = collection(db, 'slots');
    const answersCol = collection(db, 'answers');

    // UI helpers
    const $ = id => document.getElementById(id);
    const loginView = $('login-view');
    const mainView = $('main-view');
    const adminPanel = $('admin-panel');
    const salesPanel = $('sales-panel');
    const admissionPanel = $('admission-panel');

    let currentUser = null;

    // Ensure Nasr admin exists (one-time)
    (async function ensureNasr(){
      const snap = await getDocs(usersCol);
      const exists = snap.docs.find(d=>d.data().username==='Nasr');
      if(!exists){
        await addDoc(usersCol, { username:'Nasr', password:'Asdof123', role:'admin', createdAt: new Date().toISOString() });
        console.log('Nasr admin created');
      }
    })();

    // --- Real-time listeners to keep UI synced ---
    const qAll = query(questionsCol, orderBy('createdAt'));
    onSnapshot(qAll, snapshot => {
      // questions list update handled in render functions via local cache
      refreshLists();
    });

    const sAll = query(slotsCol, orderBy('time'));
    onSnapshot(sAll, snapshot => { refreshLists(); });

    const aAll = query(answersCol, orderBy('dateA'));
    onSnapshot(aAll, snapshot => { refreshLists(); });

    const uAll = query(usersCol, orderBy('username'));
    onSnapshot(uAll, snapshot => { refreshLists(); });

    // --- Login (simple check against users collection) ---
    $('btn-login').addEventListener('click', async ()=>{
      const username = $('login-username').value.trim();
      const password = $('login-password').value;
      if(!username||!password) return alert('Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±');

      const snap = await getDocs(usersCol);
      const docFound = snap.docs.find(d=>d.data().username===username && d.data().password===password);
      if(!docFound) return alert('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø®Ø§Ø·Ø¦Ø©');

      currentUser = { id: docFound.id, ...docFound.data() };
      $('user-name').textContent = currentUser.username;
      $('user-role').textContent = currentUser.role;
      loginView.classList.add('hidden'); mainView.classList.remove('hidden');
      showPanelForRole(currentUser.role);
    });

    // demo guest sales
    $('btn-demo').addEventListener('click', async ()=>{
      // create or find guest sales user
      const snap = await getDocs(usersCol);
      let udoc = snap.docs.find(d=>d.data().username==='guest_sales');
      if(!udoc){ const res = await addDoc(usersCol,{username:'guest_sales',password:'guest',role:'sales',createdAt:new Date().toISOString()}); udoc = { id: res.id, data: ()=>({username:'guest_sales',password:'guest',role:'sales'}) } }
      currentUser = { id: udoc.id, ...(udoc.data? udoc.data() : {}) };
      $('user-name').textContent = currentUser.username; $('user-role').textContent = currentUser.role;
      loginView.classList.add('hidden'); mainView.classList.remove('hidden'); showPanelForRole(currentUser.role);
    });

    $('btn-logout').addEventListener('click', ()=>{ location.reload(); });

    // show relevant panel
    function showPanelForRole(role){ adminPanel.classList.add('hidden'); salesPanel.classList.add('hidden'); admissionPanel.classList.add('hidden');
      if(role==='admin') adminPanel.classList.remove('hidden');
      if(role==='sales') salesPanel.classList.remove('hidden');
      if(role==='admission') admissionPanel.classList.remove('hidden');
      refreshLists();
    }

    // --- Admin actions ---
    $('btn-add-user').addEventListener('click', async ()=>{
      if(!currentUser || currentUser.role!=='admin') return alert('Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ©');
      const username = $('new-username').value.trim(); const password = $('new-password').value; const role = $('new-role').value;
      if(!username||!password) return alert('Ø§ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
      // check duplicate
      const snap = await getDocs(usersCol);
      if(snap.docs.find(d=>d.data().username===username)) return alert('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„');
      await addDoc(usersCol,{username,password,role,createdAt:new Date().toISOString()});
      $('new-username').value=''; $('new-password').value='';
      alert('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©');
    });

    $('btn-clear-data').addEventListener('click', async ()=>{
      if(!currentUser || currentUser.role!=='admin') return alert('Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ©');
      if(!confirm('Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† users/questions/slots/answers Ù…Ù† FirestoreØŸ')) return;
      // caution: deletes all docs in collections
      await deleteCollection(usersCol);
      await deleteCollection(questionsCol);
      await deleteCollection(slotsCol);
      await deleteCollection(answersCol);
      // recreate Nasr
      await addDoc(usersCol, { username:'Nasr', password:'Asdof123', role:'admin', createdAt:new Date().toISOString() });
      alert('ØªÙ… Ø§Ù„Ù…Ø³Ø­ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ Nasr');
    });

    // utility to delete all docs in a collection (small-scale)
    async function deleteCollection(colRef){
      const snap = await getDocs(colRef);
      const promises = snap.docs.map(d=> deleteDoc(doc(db, colRef.id, d.id)) );
      // note: colRef.id gives name, but deleteDoc requires doc ref; reconstruct
      // safer approach: use each doc ref from snap
      await Promise.all(snap.docs.map(d=> deleteDoc(d.ref)));
    }

    // --- Sales actions ---
    $('btn-add-question').addEventListener('click', async ()=>{
      if(!currentUser) return alert('Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
      const text = $('sales-question').value.trim(); if(!text) return alert('Ø§ÙƒØªØ¨ Ø§Ù„Ø³Ø¤Ø§Ù„');
      await addDoc(questionsCol, { text, from: currentUser.username, createdAt: new Date().toISOString(), answered: false });
      $('sales-question').value='';
      alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù„Ù„Ø£Ø¯Ù…Ø´Ù†');
    });

    $('btn-add-slot').addEventListener('click', async ()=>{
      if(!currentUser) return alert('Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
      const time = $('sales-slot').value; const duration = parseInt($('sales-slot-duration').value)||0; const capacity = parseInt($('sales-slot-capacity').value)||1;
      if(!time) return alert('Ø­Ø¯Ø¯ ÙˆÙ‚Øª Ø§Ù„Ù…ÙˆØ¹Ø¯');
      await addDoc(slotsCol, { time, duration, capacity, from: currentUser.username, confirmed: false, confirmedBy: null, createdAt: new Date().toISOString() });
      $('sales-slot').value=''; $('sales-slot-duration').value=''; $('sales-slot-capacity').value='1';
      alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…ÙˆØ¹Ø¯');
    });

    // --- Admission actions ---
    window.answerQuestion = async function(questionId){
      if(!currentUser) return alert('Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„');
      const val = $('ans-'+questionId).value.trim(); if(!val) return alert('Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ø¯');
      // add answer doc
      const qSnap = await getDocs(questionsCol);
      const qDoc = qSnap.docs.find(d=>d.data().id===questionId || d.id===questionId);
      // find question reference
      const questionRef = doc(db, 'questions', questionId);
      // update question answered flag
      await updateDoc(questionRef, { answered:true, answeredAt: new Date().toISOString() });
      // add to answers collection (store who answered and question metadata)
      await addDoc(answersCol, { questionId, questionText: (qDoc? qDoc.data().text : ''), questionFrom: (qDoc? qDoc.data().from : ''), answer: val, answeredBy: currentUser.username, questionTs: qDoc? qDoc.data().createdAt : null, answeredAt: new Date().toISOString() });
      alert('ØªÙ… Ø§Ù„Ø±Ø¯');
    };

    window.confirmSlot = async function(slotId){
      if(!currentUser) return alert('Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„');
      const slotRef = doc(db, 'slots', slotId);
      await updateDoc(slotRef, { confirmed: true, confirmedBy: currentUser.username, confirmedAt: new Date().toISOString() });
      alert('ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯ â€” Ø³ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ù†Ø¨Ù‡ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…ÙØªÙˆØ­Ø© Ù‚Ø¨Ù„ 30 Ø¯Ù‚ÙŠÙ‚Ø© Ù…Ù† Ø§Ù„Ù…ÙˆØ¹Ø¯');
    };

    // --- Rendering / Lists ---
    async function refreshLists(){
      // users
      const uSnap = await getDocs(usersCol);
      const users = uSnap.docs.map(d=>({ id:d.id, ...d.data() }));
      renderUsers(users);

      // questions (pending)
      const qSnap = await getDocs(qAll);
      const questions = qSnap.docs.map(d=>({ id:d.id, ...d.data() }));
      renderPendingQuestions(questions.filter(q=>!q.answered));

      // slots
      const sSnap = await getDocs(sAll);
      const slots = sSnap.docs.map(d=>({ id:d.id, ...d.data() }));
      renderSlots(slots);

      // answers
      const aSnap = await getDocs(aAll);
      const answers = aSnap.docs.map(d=>({ id:d.id, ...d.data() }));
      renderAnswered(answers);

      // sales answered view
      renderSalesSlotsAndAnswers(slots, answers);
    }

    function renderUsers(users){
      if(!currentUser || currentUser.role!=='admin') return;
      const html = users.map(u=>{
        return `<div class='item'>${u.username} â€¢ ${u.role} ${u.username!=='Nasr' ? `<button onclick="deleteUser('${u.id}','${u.username}')" style='background:#e74c3c;margin-left:8px'>Ø­Ø°Ù</button>` : ''}</div>`
      }).join('');
      $('user-list').innerHTML = html || '<div class="meta">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙŠÙ†</div>';
    }

    window.deleteUser = async function(docId, username){
      if(!currentUser || currentUser.role!=='admin') return alert('Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ©');
      if(username==='Nasr') return alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Nasr');
      if(!confirm('Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… '+username+'ØŸ')) return;
      await deleteDoc(doc(db,'users',docId));
      alert('ØªÙ… Ø§Ù„Ø­Ø°Ù');
    };

    function renderPendingQuestions(questions){
      const html = questions.map(q=>`<div class='item'><b>${escapeHtml(q.text)}</b><div class='meta'>Ø³Ø£Ù„: ${escapeHtml(q.from)} â€¢ ${new Date(q.createdAt).toLocaleString()}</div><div style='margin-top:8px'><input id='ans-${q.id}' placeholder='Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ø¯ Ù‡Ù†Ø§'><button onclick="answerQuestion('${q.id}')">Ø£Ø±Ø³Ù„ Ø§Ù„Ø±Ø¯</button></div></div>`).join('');
      $('pending-questions').innerHTML = html || '<div class="meta">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</div>';
    }

    function renderSlots(slots){
      // sort upcoming and past
      const now = Date.now();
      const upcoming = slots.filter(s=> new Date(s.time).getTime() >= now ).sort((a,b)=>new Date(a.time)-new Date(b.time));
      const passed = slots.filter(s=> new Date(s.time).getTime() < now ).sort((a,b)=>new Date(b.time)-new Date(a.time));

      const combine = [...upcoming, ...passed];
      const html = combine.map(s=>{
        return `<div class='item'><b>${new Date(s.time).toLocaleString()}</b><div class='meta'>Ø£Ø¶Ø§ÙÙ‡: ${escapeHtml(s.from)} â€¢ ${s.confirmed?('<span style="color:green">Ù…Ø¤ÙƒØ¯ Ø¨ÙˆØ§Ø³Ø·Ø© '+escapeHtml(s.confirmedBy)+'</span>'):'<span style="color:orange">ØºÙŠØ± Ù…Ø¤ÙƒØ¯</span>'}</div>${s.confirmed? '': ` ${currentUser && currentUser.role==='admission' ? `<div style="margin-top:8px"><button onclick="confirmSlot('${s.id}')">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…ÙˆØ¹Ø¯</button></div>` : ''}`}</div>`
      }).join('');
      $('pending-slots').innerHTML = html || '<div class="meta">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¹ÙŠØ¯</div>';
      $('sales-slots').innerHTML = html || '<div class="meta">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¹ÙŠØ¯</div>';
    }

    function renderAnswered(answers){
      const html = answers.map(a=>{
        const diff = a.diff || ((new Date(a.answeredAt||a.dateA) - new Date(a.questionTs||a.dateQ))/60000).toFixed(1);
        return `<div class='item'><b>${escapeHtml(a.questionText||a.question)}</b><div class='meta'>Ø³Ø£Ù„: ${escapeHtml(a.questionFrom||a.from)} â€¢ Ø£Ø¬Ø§Ø¨: ${escapeHtml(a.answeredBy||a.answeredBy)} </div><div class='meta'>Ø³ÙØ¦Ù„: ${new Date(a.questionTs||a.dateQ).toLocaleString()} â€¢ Ø£ÙØ¬ÙŠØ¨: ${new Date(a.answeredAt||a.dateA).toLocaleString()} â€¢ Ø§Ù„ÙØ§ØµÙ„: ${diff} Ø¯Ù‚ÙŠÙ‚Ø©</div><div style='margin-top:8px'>Ø§Ù„Ø±Ø¯: ${escapeHtml(a.answer)}</div></div>`
      }).join('');
      $('answered-questions').innerHTML = html || '<div class="meta">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø¯ÙˆØ¯ Ø¨Ø¹Ø¯</div>';
      $('sales-answers').innerHTML = html || '<div class="meta">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø¯ÙˆØ¯ Ø¨Ø¹Ø¯</div>';
    }

    function renderSalesSlotsAndAnswers(slots, answers){
      // reuse renderAnswered for answers; sales slots shown elsewhere
      renderAnswered(answers);
      renderSlots(slots);
    }

    // export (download) current Firestore data as JSON snapshot
    $('btn-export').addEventListener('click', async ()=>{
      const u = (await getDocs(usersCol)).docs.map(d=>({id:d.id,...d.data()}));
      const q = (await getDocs(questionsCol)).docs.map(d=>({id:d.id,...d.data()}));
      const s = (await getDocs(slotsCol)).docs.map(d=>({id:d.id,...d.data()}));
      const a = (await getDocs(answersCol)).docs.map(d=>({id:d.id,...d.data()}));
      const blob = new Blob([JSON.stringify({users:u,questions:q,slots:s,answers:a},null,2)],{type:'application/json'});
      const url = URL.createObjectURL(blob); const aEl = document.createElement('a'); aEl.href=url; aEl.download='export.json'; aEl.click(); URL.revokeObjectURL(url);
    });

    // small util
    function escapeHtml(str){ if(!str) return ''; return str.replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])) }

    // initial refresh
    refreshLists();
  </script>
</body>
</html>